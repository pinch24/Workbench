[언리얼 C++ 게임 개발의 정석 by 이득우, 2018][1]

# 들어가며
## 프로그래머 관점에서의 언리얼 엔진 시스템
- 언리얼 엔진의 빌드 시스템
- 언리얼 엔진의 모듈 시스템
- 언리얼 엔진의 샐행 환경(Runtime)
- 언리얼 엔진 오브젝트의 선언과 관리
- 언리얼 엔진 C\++의 기능

## 크리에이터 입장에서의 언리얼 엔진 시스템
- 게임 컨텐츠를 수용하는 환경(월드, World)ed
- 게임 컨텐츠의 기본 단위(액터, Actor)
- 게임 플레이가 진행되는 배경(레벨, Level)
- 게임 플레이어에게 부여되는 액터
- 게임의 룰과 게임 모드 액터
- 게임 제작에 필요한 보조 기능
---- 

# 1. 개발 환경 설정
![][image-1]
## Content 디렉토리
언리얼 엔진은 게임 프로젝트 에셋을 프로젝트의 Content 폴더에서 관리한다.
- Config: 게임 프로젝트의 설정 값을 저장한다.
- Content: 게임 프로젝트의 에셋을 저장한다.
- Intermediate: 게임 프로젝트의 관리에 필요한 임시 파일을 저장한다.
- Saved: 게임 프로젝트의 작업 중에 생성된 세이브, 스크린샷 등의 결과물을 저장한다.

## Unreal 프로젝트 파일
`ArenaBattle.uproject`
```json
{
	"FileVersion": 3,
	"EngineAssociation": "5.0EA",
	"Category": "",
	"Description": ""
}
```

## C\++ 프로젝트로 확장
![]()

<!--
![1.2.1.gif][1.2.1]
![1.2.2.gif][1.2.2]
![1.2.3.gif][1.2.3]
![1.2.4.gif][1.2.4]
![1.2.5.gif][1.2.5]
![1.2.6.gif][1.2.6]
-->

C\++ 클래스가 생성되고 컴파일이 진행되면 블루프린트만 가능하던 게임 프로젝트가 C\++ 프로그래밍도 가능한 프로젝트로 변경된다.
프로젝트 전환이 끝나면 프로젝트에는 Visual Studio 파일들이 생성된다.
- Binaries/: C\++ 코드가 컴파일된 결과물을 임시로 저장한다.
- Source/: C\++ 코드를 저장한다. 언리얼 엔진 빌드 설정을 담은 C# 파일도 저장한다.
- .sln: C\++ 프로젝트를 관리하기 위한 Visual Studio 파일이다. 이 파일이 관리하는 대상은 Intermediate/ProjectFiles 폴더에 있다.
- .vs/: Visual Studio 설정을 저장한다.

## Unreal C\++ 프로젝트 파일
`ArenaBattle.uproject`
```json
{
	"FileVersion": 3,
	"EngineAssociation": "5.0EA",
	"Category": "",
	"Description": "",
	"Modules": [
		{
			"Name": "ArenaBattle",
			"Type": "Runtime",
			"LoadingPhase": "Default",
			"AdditionalDependencies": [
				"Engine"
			]
		}
	]
}
```
C\++ 프로젝트로 변환되면 Modules 항목이 추가된다. 언리얼 엔진 에디터가 시작될 때 Modules에 있는 내용도 함께 로딩하라는 의미로 게임 프로젝트의 Binaries/ 폴더에서 해당 모듈을 찾는다. 없으면 이 파일을 생성하기 위한 빌드를 진행하게 된다.
---- 

# Unreal C\++ 개발 환경 설정
## Visual Studio 에디터 툴바 설정 변경
![]()

## Visual Studio 빌드 구성
- DebugGame: 디버깅을 위해 최적화 안 된 EXE 빌드 생성
- DebugGame Editor: DebugGame의 에디터용 DLL 빌드 생성
- Development: 디버깅이 가능한 최적화된 EXE 빌드 생성
- Development Editor: Development의 에디터용 DLL 빌드 생성
- Shipping: 배포를 위해 최적화된 EXE 빌드 생성

Visual Studio에서 빌드한 EXE 파일은 언리얼 엔진에서 리소스와 묶인 패키지 형태로 배포되어야 한다. Visual Studio 빌드는 리소스 없이 실행 파일만 빌드한다.
---- 

# 예제 프로젝트 준비
![]()
```go
에픽게임즈 런처
--> 언리얼 엔진 탭
--> 마켓플레이스 세그먼트
--> 검색: `Infinity Grass`
--> [프로젝트에 추가]
--> 추가할 프로젝트 선택: `ArenaBattle`
--> 	버전 선택: `5.0EA`
--> 언리얼 엔진 에디터
--> 프로젝트 확인: `Content / InfinityBladeGrassLands`
--> 레벨 로딩: `Content / InfinityBladeGrassLands / Maps / ElvenRuins`
--> 	대기: 에셋 초기화 --> 레벨 로딩 --> 셰이더 컴파일
--> 테스트: [플레이]
```

## 예제 레벨 제작
![]()

## 예제 레벨 생성
![]()

## 예제 레벨 저장
![]()

## 에디터 시작 레벨 설정
![]()

# Git LFS
![]()
---- 

# 2. 액터의 설계

## 언리얼 컨텐츠의 구성 요소
### 월드
언리얼 엔진이 만든 가상 세계를 월드\_world\_라고 부른다. 이 작업 공간은 뷰포트를 통해 보여진다.

#### 월드의 구성 요소
- 공간\_space\_: 가상 세계를 구성하는 3차원의 영역이다. 트랜스폼\_Transform\_이라는 구조체를 통해 위치를 나타낸다. 공간의 기본 단위는 cm이다.
- 시간\_Time\_: 가상 공간에서 흐르는 시간이다. 초 단위로 흘러가지만 시간을 빠르게 혹은 느리게 흘러가도록 시간의 스케일을 조절할 수 있다.
- 물리\_Physics_: 월드 공간에 배치된 물체에 작용하는 물리적인 환경이다. 중력과 콜리전_Collision_ 정보가 대표적이다.
- 렌더링\_Rendering_: 엔진이 제공하는 시각적인 기능이다. 빛과 이에 반응하는 머티리얼로 구성되며, 언리얼 엔진은 물리 기반 렌더링_Physically Based Rendering_ 시스템을 제공한다.

### 액터
액터\_Actor\_는 언리얼 엔진에서 컨텐츠를 구성하는 최소 단위의 물체다. 액터는 월드의 특정 공간에서 자신에게 주어진 역할을 수행하는 물체를 의미한다.

#### 액터의 구성요소
- 이름\_name\_: 액터에 부여된 명칭이다. 여러 액터가 같은 이름을 가질 수 있다.
- 유형\_type\_: 게임 플레이에서 수행할 액터의 역할을 의미한다. 프로그래밍에서는 액터의 클래스 이름이다.
- 트랜스폼\_transform\_: 월드에 위치하는 액터의 정보이다.
- 프로퍼티\_property\_: 액터에 설정된 속성 값이다. 액터의 유형에 따라 서로 다른 속성을 제공한다.
- 게임 로직\_game logic\_: 액터에 특정 상황이 발생할 때 이에 대응할 구체적인 행동을 명령하기 위해 필요한 프로그래밍 코드이다. 언리얼 엔진은 블루프린트와 C++ 두 가지 형태를 지원한다.
### 레벨
레벨\_level\_은 플레이어에게 주어지는 스테이지를 의미한다.  
언리얼 엔진의 레벨은 월드에 배치된 액터들의 집합이다.


### 컴포넌트
#### 게임에서 액터의 주요 기능
- 시각적 기능: 플레이어에게 어떻게 보여질 것인가?
- 물리적 기능: 액터의 이동과 액터들 간의 상호 동작을 어떻게 할 것인가?
- 움직임: 액터가 어떤 움직임을 가질 것인가?

액터의 역할에 따라 각 기능의 사용 여부가 정해진다. 액터를 설계할 때 이러한 다양한 경우에 대처하기 위해 언리얼 엔진은 각 기능을 규격화하고 액터가 이들을 조합할 수 있도록 설계했는데, 이러한 규격화된 기능을 컴포넌트라고 한다.

#### 주요 컴포넌트
- 스태틱메시 컴포넌트\_StaticMesh Component\_: 애니메이션이 없는 모델링 에셋이다. 시각적인 기능과 물리적인 기능을 제공하는 모듈이다. 주로 배경 물체에 사용한다.
- 스켈레탈메시 컴포넌트\_SkeletalMesh Component\_: 애니메이션 정보가 있는 모델링 에셋이다. 시각적인 기능과 물리적인 기능 그리고 애니메이션을 제공하는 모듈이다. 주로 캐릭터에 사용한다.
- 콜리전 컴포넌트\_Collision Component\_: 구/박스/캡슐로 지정한 영역에 물리적인 기능을 설정하기 위해 제공하는 모듈이다. 시각적인 기능은 없다.
- 카메라 컴포넌트\_Camera Component\_: 가상 세계에서 보여지는 현재 상황을 플레이어의 모니터 화면에 출력해주는 모듈이다.
- 오디오 컴포넌트\_Audio Component\_: 가상 세계에서 소리를 발생시키는 데 사용하는 기능이다.
- 파티클 시스템 컴포넌트\_Particle System Component\_: 파티클 시스템으로 설계된 이펙트를 화면에 보여주기 위한 모듈이다.
- 라이트 컴포넌트\_Light Component\_: 물체에 광원 효과를 부여하는 모듈이다.
- 무브먼트 컴포넌트\_Movement Component\_: 물체에 특정한 움직임을 부여하는 모듈이다.

액터는 여러 개의 컴포넌트를 가질 수 있으며, 대표하는 컴포넌트 하나는 반드시 지정되어야 한다. 이를 루트 컴포넌트\_Root Component\_라고 한다.
---- 

## 액터의 설계
#### IWYU(Include What You Use) 구성
언리얼 엔진 4.15 버전 부터 C++ 프로젝트를 IWYU 방식으로 구성하여 불필요한 헤더 파일의 참조로 인한 컴파일 시간과 인텔리전스의 부하를 최소화하는데, 이로 인해 C++ 템플릿은 언리얼 오브젝트가 동작할 수 있는 최소 기능만 선언된 `CoreMinimal.h` 헤더 파일만 참조한다. 
다양한 엔진 기능을 사용하기 위해서는 `EngineMinimal.h` 헤더 파일을 참조하도록 변경한다.

#### 언리얼 오브젝트 클래스 규칙
- 클래스 선언 매크로: 클래스 선언 윗줄에 `UCLASS` 매크로를 선언하고 클래스 내부에는 `GENERATED_BODY_` 매크로를 선언한다.
- 클래스 이름 접두사: 언리얼 오브젝트에는 U와 A가 접두사로 제공된다. A는 액터 클래스에 사용하고 U는 언리얼 엔진 클래스에 사용한다.
- generated.h 헤더 파일: 소스 코드를 컴파일하기 전에 언리얼 엔진은 언리얼 헤더 툴\_Unreal Header Tool\_을 사용해 클래스 선언을 분석하고 언리얼 실행 환경에 필요한 부가 정보를 별도의 파일에 생성한다. 언리얼 헤더 툴에 의해 자동으로 생성되는 부가 파일이 generated.h 파일이다. 언리얼 오브젝트 선언의 마지막 #include 구문에 이 헤더 파일을 반드시 선언해야 한다.
- 외부 모듈 공개 여부: 윈도우의 DLL 시스템은 DLL 내 클래스 정보를 외부에 공개할지 결정하는 `_declspec(dllexport)`라는 키워드를 제공한다. 언리얼 엔진에서 이 키워드를 사용하려면 `모듈명_API_` 키워드를 클래스 선언 앞에 추가한다. 이 키워드가 없으면 다른 모듈에서 해당 객체에 접근할 수 없다.

```cpp
#pragma once

#include "CoreMinimal.h"
#include "GameFramework/Actor.h"
#include "Fountain.generated.h"

UCLASS()
class ARENABATTLE_API AFountain : public AActor
{
	GENERATED_BODY()
	...
}
```

액터의 구축은 클래스의 생성자 코드에서 진행되며 컴포넌트를 실제로 생성하는 로직을 구현한다.
언리얼 엔진은 new가 아닌 `CreateDefaultSubobject` API를 제공한다.
CreateDefaultSubobject API에 사용하는 문자열 값은 액터에 속한 컴포넌트를 구별하기 위한 Hash 값 생성에 사용된다. 따라서 어떤 값을 넣어도 상관없지만 다른 컴포넌트와 중복되지 않는 유일한 값을 지정해야 한다.
TEXT() 매크로는 모든 플랫폼에서 2 바이트 문자열 체계를 유지시켜준다.

#### 핫 리로드(Hot Reload)
언리얼 에디터가 사용하고 있는 모듈을 컴파일하면 기존 모듈을 내리고 새로 컴파일 된 모듈로 바꾸는 작업을 수행한다. 이러한 동작을 핫 리로드\_Hot Reload\_라고 한다. 이때 컴파일 된 모듈은 기존 모듈을 덮어 쓰지 않고 이름 뒤에 숫자를 붙인 새로운 파일로 생성된다.
언리얼 에디터를 다시 실행하고 컴파일을 수행하면 `_0` 부터 다시 생성한다.

## 액터의 주요 이벤트 함수

---- 

[1]:	http://www.acornpub.co.kr/book/unreal-c

[image-1]:	https://raw.githubusercontent.com/pinch24/Workbench/main/Inbox/%EC%96%B8%EB%A6%AC%EC%96%BC%20C%2B%2B%20%EA%B2%8C%EC%9E%84%20%EA%B0%9C%EB%B0%9C%EC%9D%98%20%EC%A0%95%EC%84%9D%20by%20%EC%9D%B4%EB%93%9D%EC%9A%B0%2C%202018/1.1.jpg
